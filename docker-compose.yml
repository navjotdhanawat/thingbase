services:
  postgres:
    image: postgres:16-alpine
    container_name: iot-postgres
    ports:
      - "5433:5432"
    environment:
      POSTGRES_DB: iot
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: iot-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # EMQX MQTT Broker with HTTP Authentication
  # For local dev, uses built-in auth. For production, uses HTTP auth to API.
  emqx:
    image: emqx/emqx:5.8
    container_name: iot-emqx
    ports:
      - "1883:1883" # MQTT TCP
      - "8083:8083" # MQTT WebSocket
      - "18083:18083" # Dashboard
    environment:
      EMQX_NODE__NAME: "emqx@127.0.0.1"
      EMQX_CLUSTER__DISCOVERY_STRATEGY: "static"
      EMQX_LOG__CONSOLE__LEVEL: "info"
      EMQX_DASHBOARD__DEFAULT_USERNAME: "admin"
      EMQX_DASHBOARD__DEFAULT_PASSWORD: "public"
      # Allow anonymous for local development (disable in production!)
      EMQX_ALLOW_ANONYMOUS: "true"
    volumes:
      - emqx_data:/opt/emqx/data
    healthcheck:
      test: [ "CMD", "emqx", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
  redis_data:
  emqx_data:


